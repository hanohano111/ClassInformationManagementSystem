# 第五章 系统测试与验证

本章围绕班级信息管理系统（微信小程序 + 微信云开发）从测试目标、测试环境、测试方法、功能测试、非功能测试、安全与权限验证、缺陷与回归等方面对系统进行测试与验证，确保系统满足第三章需求并与第四章实现一致。

## 5.1 测试目标与范围

### 5.1.1 测试目标

- 验证系统各功能模块（登录、班级、通知、作业、请假、签到、消息中心、个人信息）符合需求并能稳定运行。
- 验证权限控制（普通用户/管理员）正确，防止越权访问与越权操作。
- 验证敏感数据的加密/解密流程在已实现场景中正确生效，并明确当前未加密字段的风险与验证点。
- 验证系统在常见网络条件与主流机型上的可用性与兼容性。

### 5.1.2 测试范围

- **前端**：页面展示、交互、表单校验、附件上传、消息汇总与本地归档/删除（本地存储）。
- **云函数**：业务处理、参数校验、权限校验、与云数据库/云存储交互。
- **云数据库**：集合结构、关键索引、数据一致性与隔离性。

不在本章重点范围（若未实现可不测）：定位签到 UI（仅保留云函数）、聊天模块的完整实时通信能力。

## 5.2 测试环境与工具

### 5.2.1 测试环境

- **开发工具**：微信开发者工具（建议使用项目配置中的基础库版本或更高版本）
- **运行环境**：微信客户端（Android / iOS）
- **后端**：微信云开发环境（云函数 + 云数据库 + 云存储）
- **网络条件**：Wi-Fi / 4G/5G（可在开发者工具中模拟弱网）

### 5.2.2 测试工具与方法

- **功能测试**：黑盒测试（等价类、边界值、异常路径）
- **接口与日志**：云函数日志、数据库控制台数据核对
- **兼容性**：不同机型/分辨率、不同系统版本
- **性能**：页面加载耗时与云函数响应耗时（开发者工具性能面板/云函数日志）

## 5.3 测试方法与测试流程

### 5.3.1 测试方法

- **等价类划分**：例如班级码、签到码输入的合法/非法集合。
- **边界值分析**：例如签到码长度 4 位、班级码长度 6 位、截止时间临界点等。
- **异常路径测试**：网络失败、云函数返回非 200、权限不足等场景。
- **回归测试**：修复缺陷后对关联模块复测，确保不引入新问题。

### 5.3.2 测试流程

```mermaid
flowchart LR
  A[需求与实现梳理] --> B[制定测试用例]
  B --> C[准备测试数据/账号]
  C --> D[执行功能测试]
  D --> E[执行安全/权限验证]
  E --> F[执行性能/兼容性测试]
  F --> G[记录缺陷与复现步骤]
  G --> H[修复与回归测试]
  H --> I[测试报告与结论]
```

## 5.4 功能测试

本节按模块给出核心测试用例。用例字段统一包含：用例编号、测试目标、前置条件、测试步骤、预期结果。

### 5.4.1 登录与用户身份识别测试（OpenID）

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-LOGIN-01 | 首次登录自动创建用户 | 云开发环境可用 | 打开小程序 → 同意协议 → 点击登录 | 云函数 `login` 返回成功；`users` 集合新增记录，包含 `openid` 与默认字段 |
| TC-LOGIN-02 | 非首次登录复用用户 | 已存在 `users.openid` 记录 | 重新进入小程序并登录 | 不重复创建；返回同一 `userId` |
| TC-LOGIN-03 | 协议未勾选拦截 | 无 | 未勾选协议点击登录 | 前端提示并阻止调用云函数 |

### 5.4.2 个人信息查询与修改测试（含加密）

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-PROFILE-01 | 查看个人信息 | 已登录 | 进入“我的”页面 | 页面展示用户信息；缺省字段为空不报错 |
| TC-PROFILE-02 | 修改姓名/学号/手机号等敏感字段 | 已登录 | 进入编辑页 → 填写姓名、学号、手机号 → 保存 | 前端对字段加密并传输；云函数解密后写库并再次加密存储；库中存在对应 `_iv` 字段 |
| TC-PROFILE-03 | 修改头像 | 已登录 | 选择头像 → 保存 | 文件上传成功；数据库保存头像 fileID/URL；不影响其他字段 |
| TC-PROFILE-04 | 参数缺失/异常 | 已登录 | 清空必填字段（若有）或传入异常值保存 | 前端/云函数给出合理错误提示；不产生脏数据 |

### 5.4.3 班级管理测试

#### 5.4.3.1 创建班级

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-CLASS-01 | 创建班级成功 | 已登录（管理员即创建者） | 进入创建班级页 → 填写信息 → 创建 | `courses` 新增班级；`course_members` 自动新增创建者且 `role=admin`；班级码唯一 |
| TC-CLASS-02 | 班级码重复处理 | 人工构造重复码或触发随机重复 | 创建班级 | 云函数返回“班级码已存在”；前端提示重新生成 |

#### 5.4.3.2 加入/退出/隐藏班级

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-CLASS-03 | 加入班级成功 | 已登录；存在班级码 | 输入班级码加入 | `course_members` 新增成员记录；班级列表出现该班级 |
| TC-CLASS-04 | 重复加入拦截 | 已加入该班级 | 再次输入同一码加入 | 云函数返回“已加入”；前端提示 |
| TC-CLASS-05 | 退出班级成功 | 已加入班级 | 班级信息页点击退出并确认 | 成员记录删除；返回列表不再显示 |
| TC-CLASS-06 | 隐藏班级（本地） | 已加入班级 | 在列表隐藏班级 | 本地存储写入 hiddenClassIds；列表不展示但数据库不变 |

### 5.4.4 通知管理测试

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-NOTICE-01 | 管理员发布通知 | 管理员身份；进入班级通知页 | 填写标题正文 → 可选上传附件 → 发布 | `notices` 新增记录；成员端可见；消息中心出现通知消息 |
| TC-NOTICE-02 | 普通用户禁止发布 | 普通成员 | 尝试进入发布/调用创建 | 云函数返回无权限；前端提示 |
| TC-NOTICE-03 | 删除通知 | 管理员或创建者 | 在通知列表左滑删除并确认 | 通知记录删除；列表刷新；消息中心下次拉取不再包含该通知 |

### 5.4.5 作业管理测试

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-ASSIGN-01 | 管理员发布作业 | 管理员身份 | 发布作业（含截止时间与附件） | `assignments` 新增记录；成员端可见 |
| TC-ASSIGN-02 | 用户提交作业 | 普通成员；作业存在 | 进入提交页 → 填写内容/上传附件 → 提交 | `assignment_submissions` 新增或更新记录；页面提示成功并刷新状态 |
| TC-ASSIGN-03 | 重复提交覆盖/更新 | 已提交过 | 再次提交 | 云函数更新原记录（updatedAt 变化）；不生成重复记录 |
| TC-ASSIGN-04 | 删除作业及提交联动 | 管理员/创建者 | 删除作业 | 作业记录删除；关联提交记录批量删除；列表刷新 |

> 加密验证点：当前实现中作业发布/提交内容可能未加密（以项目实际实现为准），测试需核对库中是否以明文存储并记录风险说明。

### 5.4.6 请假管理测试

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-LEAVE-01 | 用户提交请假 | 普通成员 | 填写日期/原因/附件 → 提交 | `leave_requests` 新增记录，状态为待审批；消息中心出现待审批/状态消息（角色相关） |
| TC-LEAVE-02 | 管理员审批通过 | 管理员身份 | 打开请假详情 → 同意 → 提交 | 状态更新为通过；写入审批时间与意见；用户端可见状态变化 |
| TC-LEAVE-03 | 普通用户禁止审批 | 普通成员 | 尝试审批操作 | 云函数返回无权限；不更新数据 |

> 加密验证点：请假原因/审批意见当前实现可能未加密（以项目实际实现为准），测试需核对库中是否以明文存储并记录风险说明。

### 5.4.7 签到管理与签到测试

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-CHECKIN-01 | 管理员生成签到码 | 管理员身份 | 进入签到页 → 生成签到码 | `checkin_codes` 新增；旧的未过期签到码被标记过期；默认有效期为 5 分钟 |
| TC-CHECKIN-02 | 用户签到成功 | 普通成员；有未过期签到码 | 输入 4 位签到码签到 | `checkin_records` 新增；重复签到被拦截 |
| TC-CHECKIN-03 | 过期签到码拦截 | 签到码已过期 | 输入过期码签到 | 云函数返回“无效或已过期”；不写入记录 |
| TC-CHECKIN-04 | 查看/删除签到记录 | 管理员身份 | 进入记录页查看 → 删除某签到任务 | 删除 `checkin_codes` 及关联 `checkin_records`；页面刷新 |

### 5.4.8 消息中心测试

| 用例编号 | 测试目标 | 前置条件 | 测试步骤 | 预期结果 |
|---|---|---|---|---|
| TC-MSG-01 | 汇总近一周消息 | 已加入班级并有通知/作业/请假/签到记录 | 进入消息页 | 云函数返回消息列表按时间倒序；点击可跳转对应详情页 |
| TC-MSG-02 | 本地删除/归档 | 已有消息 | 左滑归档/删除 | 本地存储写入 archived/deleted；列表即时更新；不影响数据库 |

## 5.5 安全与权限验证

### 5.5.1 访问控制验证

- **越权拦截**：普通成员调用管理员云函数（如 `createNotice`、`deleteAssignment`、`approveLeaveRequest`、`generateCheckInCode`）应返回 `403`。
- **数据隔离**：用户不得通过任意入口查看不属于其班级的数据（班级详情、成员列表、通知/作业/请假/签到记录等）。

### 5.5.2 加密与敏感数据验证

针对已实现加密的字段（如用户姓名/学号/手机号等），验证点如下：\n

- **传输链路**：前端请求参数中包含密文与 `*_iv`；云函数能正确解密并处理。
- **落库形态**：数据库存储密文与 `*_iv`；敏感字段不以明文出现；手机号存在 `phone_hash` 便于查询。
- **日志脱敏**：云函数日志不打印明文敏感数据（或使用占位符）。

对当前未加密字段（如作业提交内容、请假原因、审批意见等，若项目实现为明文），在测试报告中记录为**安全风险项**并给出改进建议（后续版本可引入加密存储）。

## 5.6 性能与兼容性测试

### 5.6.1 性能测试要点

- **页面加载**：首页/班级列表/作业列表/消息页在常用网络下首次进入不超过 3 秒（以实际测量为准）。
- **云函数响应**：`getMessages`、`getAssignments`、`getCheckInRecords` 等聚合查询应在可接受范围内返回（以日志统计为准）。

### 5.6.2 兼容性测试要点

- **系统版本**：Android 与 iOS 主流版本
- **屏幕适配**：不同分辨率与刘海屏
- **弱网**：弱网条件下提示友好且支持重试

## 5.7 缺陷记录与回归验证

### 5.7.1 缺陷记录模板

| 缺陷编号 | 模块 | 严重程度 | 复现步骤 | 期望结果 | 实际结果 | 修复版本 | 状态 |
|---|---|---|---|---|---|---|---|
| BUG-001 |  |  |  |  |  |  |  |

### 5.7.2 回归测试策略

- 修复后优先回归：缺陷所在模块 + 上下游关联模块（例如：作业提交修复后需回归作业列表状态、消息中心作业消息）。
- 对核心链路固定执行冒烟用例：登录 → 加入班级 → 查看通知/作业/请假/签到 → 消息中心跳转。

## 5.8 测试结论

通过上述测试用例与验证项，对系统功能正确性、权限安全性、加密流程、性能与兼容性进行综合验证。对已实现加密的个人信息字段，系统满足“加密存储、按需解密、传输安全”的要求；对当前未加密的业务内容字段（若存在），在测试结论中应明确为风险点并提出后续加固计划（如统一引入加密存储与字段级权限控制）。

