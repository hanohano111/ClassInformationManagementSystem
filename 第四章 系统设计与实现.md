# ç¬¬å››ç«  ç³»ç»Ÿè®¾è®¡ä¸å®ç°

## 4.1 ç³»ç»Ÿæ€»ä½“è®¾è®¡

### 4.1.1 ç³»ç»Ÿæ¶æ„è®¾è®¡

æœ¬ç³»ç»Ÿé‡‡ç”¨å¾®ä¿¡å°ç¨‹åº + å¾®ä¿¡äº‘å¼€å‘çš„æŠ€æœ¯æ¶æ„ï¼Œå®ç°å‰åç«¯åˆ†ç¦»çš„ Serverless æ¶æ„æ¨¡å¼ã€‚æ•´ä½“æ¶æ„åˆ†ä¸ºå››å±‚ï¼šè§†å›¾å±‚ã€é€»è¾‘å±‚ã€äº‘å‡½æ•°å±‚å’Œæ•°æ®åº“å±‚ã€‚

```mermaid
flowchart TB
    subgraph å®¢æˆ·ç«¯["å®¢æˆ·ç«¯ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰"]
        subgraph è§†å›¾å±‚["è§†å›¾å±‚ï¼ˆViewï¼‰"]
            V1[WXML æ¨¡æ¿]
            V2[WXSS/LESS æ ·å¼]
            V3[TDesign ç»„ä»¶åº“]
        end
        
        subgraph é€»è¾‘å±‚["é€»è¾‘å±‚ï¼ˆLogicï¼‰"]
            L1[Page/Component JS]
            L2[App.js å…¨å±€é€»è¾‘]
            L3[å·¥å…·æ¨¡å— utils/]
            L4[åŠ å¯†æ¨¡å— crypto.js]
        end
    end
    
    subgraph äº‘å¼€å‘["å¾®ä¿¡äº‘å¼€å‘ï¼ˆServerlessï¼‰"]
        subgraph äº‘å‡½æ•°å±‚["äº‘å‡½æ•°å±‚ï¼ˆCloud Functionsï¼‰"]
            CF1[ç”¨æˆ·è®¤è¯ç±»]
            CF2[ç­çº§ç®¡ç†ç±»]
            CF3[é€šçŸ¥/ä½œä¸šç±»]
            CF4[è¯·å‡/ç­¾åˆ°ç±»]
            CF5[æ•°æ®æŸ¥è¯¢ç±»]
        end
        
        subgraph æ•°æ®å±‚["æ•°æ®å±‚ï¼ˆCloud Databaseï¼‰"]
            DB1[(users)]
            DB2[(courses)]
            DB3[(course_members)]
            DB4[(notices)]
            DB5[(assignments)]
            DB6[(leave_requests)]
            DB7[(checkin_codes)]
            DB8[(checkin_records)]
        end
        
        subgraph å­˜å‚¨å±‚["äº‘å­˜å‚¨ï¼ˆCloud Storageï¼‰"]
            CS1[å¤´åƒæ–‡ä»¶]
            CS2[é™„ä»¶æ–‡ä»¶]
            CS3[è¯æ˜ææ–™]
        end
    end
    
    V1 --> L1
    V2 --> V1
    V3 --> V1
    L1 --> L3
    L1 --> L4
    L1 -->|wx.cloud.callFunction| CF1
    L1 -->|wx.cloud.callFunction| CF2
    L1 -->|wx.cloud.callFunction| CF3
    L1 -->|wx.cloud.callFunction| CF4
    L1 -->|wx.cloud.callFunction| CF5
    L1 -->|wx.cloud.uploadFile| CS1
    
    CF1 --> DB1
    CF2 --> DB2
    CF2 --> DB3
    CF3 --> DB4
    CF3 --> DB5
    CF4 --> DB6
    CF4 --> DB7
    CF4 --> DB8
```

**å„å±‚èŒè´£è¯´æ˜**ï¼š

| å±‚çº§ | èŒè´£ | æŠ€æœ¯å®ç° |
|-----|------|---------|
| **è§†å›¾å±‚** | è´Ÿè´£é¡µé¢å±•ç¤ºä¸ç”¨æˆ·äº¤äº’ | WXML + WXSS/LESS + TDesign ç»„ä»¶åº“ |
| **é€»è¾‘å±‚** | å¤„ç†ä¸šåŠ¡é€»è¾‘ã€æ•°æ®ç»‘å®šã€äº‹ä»¶å“åº” | JavaScript (ES6+)ã€åŠ å¯†æ¨¡å—ã€äº‹ä»¶æ€»çº¿ |
| **äº‘å‡½æ•°å±‚** | æ‰§è¡Œåç«¯ä¸šåŠ¡é€»è¾‘ã€æƒé™æ ¡éªŒã€æ•°æ®åŠ è§£å¯† | Node.js äº‘å‡½æ•°ã€wx-server-sdk |
| **æ•°æ®å±‚** | æ•°æ®æŒä¹…åŒ–å­˜å‚¨ | å¾®ä¿¡äº‘æ•°æ®åº“ï¼ˆMongoDB å…¼å®¹ï¼‰ |
| **å­˜å‚¨å±‚** | æ–‡ä»¶å­˜å‚¨ï¼ˆå¤´åƒã€é™„ä»¶ç­‰ï¼‰ | å¾®ä¿¡äº‘å­˜å‚¨ |

### 4.1.2 ç³»ç»ŸåŠŸèƒ½æ¨¡å—åˆ’åˆ†

åŸºäºç¬¬ä¸‰ç« çš„éœ€æ±‚åˆ†æï¼Œç³»ç»Ÿåˆ’åˆ†ä¸ºä»¥ä¸‹åŠŸèƒ½æ¨¡å—ï¼š

```mermaid
flowchart LR
    subgraph ç³»ç»Ÿ["ç­çº§ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ"]
        subgraph ç”¨æˆ·æ¨¡å—["ç”¨æˆ·æ¨¡å—"]
            U1[ç™»å½•æ³¨å†Œ]
            U2[ä¸ªäººä¿¡æ¯ç®¡ç†]
        end
        
        subgraph ç­çº§æ¨¡å—["ç­çº§ç®¡ç†æ¨¡å—"]
            C1[åˆ›å»ºç­çº§]
            C2[åŠ å…¥ç­çº§]
            C3[ç­çº§è®¾ç½®]
            C4[æˆå‘˜ç®¡ç†]
        end
        
        subgraph é€šçŸ¥æ¨¡å—["é€šçŸ¥ç®¡ç†æ¨¡å—"]
            N1[å‘å¸ƒé€šçŸ¥]
            N2[æŸ¥çœ‹é€šçŸ¥]
            N3[åˆ é™¤é€šçŸ¥]
        end
        
        subgraph ä½œä¸šæ¨¡å—["ä½œä¸šç®¡ç†æ¨¡å—"]
            A1[å‘å¸ƒä½œä¸š]
            A2[æŸ¥çœ‹ä½œä¸š]
            A3[æäº¤ä½œä¸š]
            A4[åˆ é™¤ä½œä¸š]
        end
        
        subgraph è¯·å‡æ¨¡å—["è¯·å‡ç®¡ç†æ¨¡å—"]
            L1[æäº¤è¯·å‡]
            L2[å®¡æ‰¹è¯·å‡]
            L3[æŸ¥çœ‹è¯·å‡]
        end
        
        subgraph ç­¾åˆ°æ¨¡å—["ç­¾åˆ°ç®¡ç†æ¨¡å—"]
            S1[ç”Ÿæˆç­¾åˆ°ç ]
            S2[ç­¾åˆ°ç ç­¾åˆ°]
            S3[ç­¾åˆ°è®°å½•]
        end
        
        subgraph æ¶ˆæ¯æ¨¡å—["æ¶ˆæ¯ä¸­å¿ƒæ¨¡å—"]
            M1[æ¶ˆæ¯æ±‡æ€»]
            M2[æ¶ˆæ¯å½’æ¡£]
        end
    end
```

**æ¨¡å—ä¸é¡µé¢å¯¹åº”å…³ç³»**ï¼š

| åŠŸèƒ½æ¨¡å— | å‰ç«¯é¡µé¢ | äº‘å‡½æ•° |
|---------|---------|--------|
| ç”¨æˆ·æ¨¡å— | `login/login`ã€`my/index`ã€`my/info-edit/index` | `login`ã€`getUserInfo`ã€`updateUserInfo` |
| ç­çº§ç®¡ç† | `class/create`ã€`class/info`ã€`class/members`ã€`class/settings` | `createClass`ã€`getClassDetail`ã€`getClassMembers`ã€`joinClass`ã€`exitClass` |
| é€šçŸ¥ç®¡ç† | `class/notices`ã€`class/notice-detail`ã€`class/notice-create` | `getNotices`ã€`getNoticeDetail`ã€`createNotice`ã€`deleteNotice` |
| ä½œä¸šç®¡ç† | `class/assignments`ã€`class/assignment-detail`ã€`class/assignment-create`ã€`class/assignment-submit` | `getAssignments`ã€`getAssignmentDetail`ã€`createAssignment`ã€`submitAssignment`ã€`deleteAssignment` |
| è¯·å‡ç®¡ç† | `class/leave`ã€`class/leave-detail`ã€`class/leave-create` | `getLeaveRequests`ã€`getLeaveRequestDetail`ã€`createLeaveRequest`ã€`approveLeaveRequest` |
| ç­¾åˆ°ç®¡ç† | `class/attendance`ã€`class/attendance-records`ã€`class/attendance-record-detail` | `generateCheckInCode`ã€`checkInByCode`ã€`getCheckInRecords`ã€`deleteCheckInCode` |
| æ¶ˆæ¯ä¸­å¿ƒ | `home/index`ã€`home/archived/index` | `getMessages` |

---

## 4.2 æ•°æ®åº“è®¾è®¡

### 4.2.1 æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

ç³»ç»Ÿä½¿ç”¨å¾®ä¿¡äº‘æ•°æ®åº“ï¼ˆåŸºäº MongoDBï¼‰ï¼Œå…±è®¾è®¡ 8 ä¸ªæ ¸å¿ƒæ•°æ®é›†åˆã€‚ä¸‹å›¾å±•ç¤ºæ ¸å¿ƒè¡¨ä¹‹é—´çš„å…³ç³»ï¼š

```mermaid
erDiagram
    users ||--o{ course_members : "åŠ å…¥"
    courses ||--o{ course_members : "åŒ…å«"
    courses ||--o{ notices : "å‘å¸ƒ"
    courses ||--o{ assignments : "å‘å¸ƒ"
    courses ||--o{ leave_requests : "æäº¤"
    courses ||--o{ checkin_codes : "ç”Ÿæˆ"
    assignments ||--o{ assignment_submissions : "æäº¤"
    checkin_codes ||--o{ checkin_records : "ç­¾åˆ°"
    users ||--o{ leave_requests : "ç”³è¯·"
    users ||--o{ assignment_submissions : "æäº¤"
    users ||--o{ checkin_records : "ç­¾åˆ°"

    users {
        string _id PK
        string openid UK "å¾®ä¿¡OpenID"
        string name "å§“å [AESåŠ å¯†]"
        string name_iv "å§“åIV"
        string avatar "å¤´åƒURL"
        string studentNo "å­¦å· [AESåŠ å¯†]"
        string studentNo_iv "å­¦å·IV"
        string phone "æ‰‹æœºå· [AESåŠ å¯†]"
        string phone_iv "æ‰‹æœºIV"
        string phone_hash "æ‰‹æœºå“ˆå¸Œç´¢å¼•"
        string college "å­¦é™¢ [AESåŠ å¯†]"
        string major "ä¸“ä¸š [AESåŠ å¯†]"
        int role "è§’è‰²"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
        timestamp updatedAt "æ›´æ–°æ—¶é—´"
    }

    courses {
        string _id PK
        string classCode UK "ç­çº§ç "
        string name "ç­çº§åç§°"
        string teacherName "æ•™å¸ˆåç§° [AESåŠ å¯†]"
        string teacherName_iv "æ•™å¸ˆåç§°IV"
        string semester "å­¦æœŸ"
        string creatorId "åˆ›å»ºè€…ID"
        string creatorOpenid "åˆ›å»ºè€…OpenID"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
    }

    course_members {
        string _id PK
        string courseId FK "ç­çº§ID"
        string userId FK "ç”¨æˆ·ID"
        string openid "ç”¨æˆ·OpenID"
        string role "è§’è‰²(admin/member)"
        timestamp joinedAt "åŠ å…¥æ—¶é—´"
    }

    notices {
        string _id PK
        string courseId FK "ç­çº§ID"
        string title "æ ‡é¢˜"
        string content "å†…å®¹"
        array attachments "é™„ä»¶åˆ—è¡¨"
        string creatorId "åˆ›å»ºè€…ID"
        string creatorOpenid "åˆ›å»ºè€…OpenID"
        string creatorName "åˆ›å»ºè€…å§“å"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
    }

    assignments {
        string _id PK
        string courseId FK "ç­çº§ID"
        string title "æ ‡é¢˜"
        string content "å†…å®¹"
        array attachments "é™„ä»¶åˆ—è¡¨"
        timestamp deadline "æˆªæ­¢æ—¶é—´"
        string creatorId "åˆ›å»ºè€…ID"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
    }

    assignment_submissions {
        string _id PK
        string assignmentId FK "ä½œä¸šID"
        string userId FK "ç”¨æˆ·ID"
        string openid "ç”¨æˆ·OpenID"
        string content "æäº¤å†…å®¹"
        array attachments "é™„ä»¶åˆ—è¡¨"
        timestamp submittedAt "æäº¤æ—¶é—´"
    }

    leave_requests {
        string _id PK
        string courseId FK "ç­çº§ID"
        string userId FK "ç”¨æˆ·ID"
        string openid "ç”¨æˆ·OpenID"
        string reason "è¯·å‡åŸå› "
        string date "è¯·å‡æ—¥æœŸ"
        timestamp startTime "å¼€å§‹æ—¶é—´"
        timestamp endTime "ç»“æŸæ—¶é—´"
        array attachments "è¯æ˜ææ–™"
        int status "çŠ¶æ€(0å¾…å®¡æ‰¹/1é€šè¿‡/2æ‹’ç»)"
        string comment "å®¡æ‰¹æ„è§"
        string studentName "å­¦ç”Ÿå§“å"
        timestamp approvedAt "å®¡æ‰¹æ—¶é—´"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
    }

    checkin_codes {
        string _id PK
        string courseId FK "ç­çº§ID"
        string code "ç­¾åˆ°ç (4ä½)"
        timestamp expireTime "è¿‡æœŸæ—¶é—´"
        string note "ç­¾åˆ°æç¤º"
        timestamp createdAt "åˆ›å»ºæ—¶é—´"
    }

    checkin_records {
        string _id PK
        string courseId FK "ç­çº§ID"
        string checkInCodeId FK "ç­¾åˆ°ç ID"
        string userId FK "ç”¨æˆ·ID"
        string openid "ç”¨æˆ·OpenID"
        string checkInType "ç­¾åˆ°ç±»å‹(code/location)"
        timestamp checkInTime "ç­¾åˆ°æ—¶é—´"
    }
```

### 4.2.2 æ•°æ®å…³ç³»ä¸ç´¢å¼•è®¾è®¡

**æ ¸å¿ƒç´¢å¼•è®¾è®¡**ï¼š

| é›†åˆ | ç´¢å¼•å­—æ®µ | ç´¢å¼•ç±»å‹ | ç”¨é€” |
|-----|---------|---------|------|
| users | openid | å”¯ä¸€ç´¢å¼• | ç”¨æˆ·ç™»å½•æŸ¥è¯¢ |
| users | phone_hash | æ™®é€šç´¢å¼• | æ‰‹æœºå·æŸ¥è¯¢ï¼ˆå“ˆå¸ŒåŒ¹é…ï¼‰ |
| courses | classCode | å”¯ä¸€ç´¢å¼• | ç­çº§ç æŸ¥è¯¢ |
| course_members | courseId + openid | å¤åˆå”¯ä¸€ç´¢å¼• | æˆå‘˜å…³ç³»æŸ¥è¯¢ã€é˜²é‡å¤åŠ å…¥ |
| notices | courseId + createdAt | å¤åˆç´¢å¼• | ç­çº§é€šçŸ¥åˆ—è¡¨æŸ¥è¯¢ |
| assignments | courseId + deadline | å¤åˆç´¢å¼• | ç­çº§ä½œä¸šåˆ—è¡¨æŸ¥è¯¢ |
| leave_requests | courseId + status | å¤åˆç´¢å¼• | è¯·å‡åˆ—è¡¨æŸ¥è¯¢ |
| checkin_codes | courseId + expireTime | å¤åˆç´¢å¼• | æœ‰æ•ˆç­¾åˆ°ç æŸ¥è¯¢ |
| checkin_records | checkInCodeId + userId | å¤åˆå”¯ä¸€ç´¢å¼• | é˜²é‡å¤ç­¾åˆ° |

### 4.2.3 æ•°æ®åŠ å¯†å­˜å‚¨æ–¹æ¡ˆ

ç³»ç»Ÿé‡‡ç”¨ AES-256-CBC ç®—æ³•å¯¹æ•æ„Ÿå­—æ®µè¿›è¡ŒåŠ å¯†å­˜å‚¨ï¼ŒåŠ å¯†å­—æ®µæ±‡æ€»å¦‚ä¸‹ï¼š

| æ•°æ®é›†åˆ | åŠ å¯†å­—æ®µ | è¯´æ˜ |
|---------|---------|------|
| users | name, studentNo, phone, college, major, teacherNo | ç”¨æˆ·ä¸ªäººæ•æ„Ÿä¿¡æ¯ |
| courses | teacherName | æ•™å¸ˆå§“å |

**åŠ å¯†å­˜å‚¨æ ¼å¼**ï¼š
- æ¯ä¸ªåŠ å¯†å­—æ®µå­˜å‚¨å¯†æ–‡ï¼ˆBase64 ç¼–ç ï¼‰
- æ¯ä¸ªåŠ å¯†å­—æ®µå¯¹åº”ä¸€ä¸ª `_iv` åç¼€å­—æ®µå­˜å‚¨åˆå§‹å‘é‡
- æ‰‹æœºå·é¢å¤–å­˜å‚¨ `phone_hash`ï¼ˆSHA-256 å“ˆå¸Œï¼‰ç”¨äºæŸ¥è¯¢

**ç¤ºä¾‹**ï¼š
```json
{
  "_id": "user_001",
  "openid": "oXXXXX",
  "name": "U2FsdGVkX1+ABC123...",
  "name_iv": "aBcDeFgHiJkLmNoP",
  "phone": "U2FsdGVkX1+XYZ789...",
  "phone_iv": "qRsTuVwXyZ012345",
  "phone_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
}
```

---

## 4.3 å‰ç«¯è®¾è®¡ä¸å®ç°

### 4.3.1 é¡µé¢å¸ƒå±€ä¸ç»„ä»¶è®¾è®¡

#### 4.3.1.1 TDesign ç»„ä»¶åº“é›†æˆ

ç³»ç»Ÿé‡‡ç”¨è…¾è®¯ TDesign å¾®ä¿¡å°ç¨‹åºç»„ä»¶åº“ï¼Œæä¾›ç»Ÿä¸€çš„è§†è§‰é£æ ¼å’Œäº¤äº’ä½“éªŒã€‚ä¸»è¦ä½¿ç”¨çš„ç»„ä»¶åŒ…æ‹¬ï¼š

| ç»„ä»¶ç±»å‹ | ç»„ä»¶åç§° | ä½¿ç”¨åœºæ™¯ |
|---------|---------|---------|
| å¯¼èˆªç»„ä»¶ | t-navbar | é¡µé¢é¡¶éƒ¨å¯¼èˆªæ  |
| è¡¨å•ç»„ä»¶ | t-inputã€t-textareaã€t-picker | ä¿¡æ¯å½•å…¥ |
| æŒ‰é’®ç»„ä»¶ | t-button | æ“ä½œæŒ‰é’® |
| åˆ—è¡¨ç»„ä»¶ | t-cellã€t-cell-group | åˆ—è¡¨å±•ç¤º |
| åé¦ˆç»„ä»¶ | t-toastã€t-dialogã€t-message | æ“ä½œåé¦ˆ |
| å±•ç¤ºç»„ä»¶ | t-avatarã€t-tagã€t-icon | ä¿¡æ¯å±•ç¤º |

#### 4.3.1.2 å…³é”®é¡µé¢å¸ƒå±€

**æ¶ˆæ¯ä¸­å¿ƒé¡µé¢ï¼ˆhome/indexï¼‰**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯ä¸­å¿ƒï¼ˆTabBar é¦–é¡µï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [é€šçŸ¥] ç­çº§A - æ–°é€šçŸ¥æ ‡é¢˜    â”‚â”‚
â”‚  â”‚ å†…å®¹æ‘˜è¦...         2åˆ†é’Ÿå‰ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [ä½œä¸š] ç­çº§B - ä½œä¸šæ ‡é¢˜      â”‚â”‚
â”‚  â”‚ æˆªæ­¢æ—¶é—´: 2026-01-25   æœªæäº¤ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [ç­¾åˆ°] ç­çº§A - ç­¾åˆ°é€šçŸ¥      â”‚â”‚
â”‚  â”‚ è¯·åœ¨5åˆ†é’Ÿå†…å®Œæˆç­¾åˆ°     æœªç­¾åˆ° â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ¶ˆæ¯]    [ç­çº§]    [æˆ‘çš„]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç­çº§åˆ—è¡¨é¡µé¢ï¼ˆmessage/indexï¼‰**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­çº§                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŠ å…¥ç­çº§]  [åˆ›å»ºç­çº§]  [éšè—ç­çº§] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ“š é«˜ç­‰æ•°å­¦(2025æ˜¥)          â”‚â”‚
â”‚  â”‚ æ•™å¸ˆ: å¼ è€å¸ˆ    æˆå‘˜: 45äºº   â”‚â”‚
â”‚  â”‚ [é€šçŸ¥] [ä½œä¸š] [è¯·å‡] [ç­¾åˆ°]  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ“š å¤§å­¦è‹±è¯­(2025æ˜¥)          â”‚â”‚
â”‚  â”‚ æ•™å¸ˆ: æè€å¸ˆ    æˆå‘˜: 50äºº   â”‚â”‚
â”‚  â”‚ [é€šçŸ¥] [ä½œä¸š] [è¯·å‡] [ç­¾åˆ°]  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ¶ˆæ¯]    [ç­çº§]    [æˆ‘çš„]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3.2 å…³é”®ä¸šåŠ¡é€»è¾‘å®ç°

#### 4.3.2.1 åŠ å¯†æ¨¡å—é›†æˆ

å‰ç«¯åŠ å¯†æ¨¡å—ä½äº `utils/crypto.js`ï¼ŒåŸºäº crypto-js åº“å®ç° AES-256-CBC åŠ å¯†ã€‚

**åŠ å¯†æµç¨‹**ï¼š

```javascript
// utils/crypto.js æ ¸å¿ƒå®ç°
const CryptoJS = require('crypto-js');

// AES-256-CBC åŠ å¯†
function encryptAES(plaintext, key, iv) {
  const fullKey = key.padEnd(32, '0').slice(0, 32);
  const encrypted = CryptoJS.AES.encrypt(plaintext, CryptoJS.enc.Utf8.parse(fullKey), {
    iv: CryptoJS.enc.Utf8.parse(iv),
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7,
  });
  return encrypted.toString();
}

// æ‰¹é‡åŠ å¯†æŒ‡å®šå­—æ®µ
async function encryptFields(data, fields) {
  const result = { ...data };
  for (const field of fields) {
    if (result[field] !== undefined && result[field] !== null) {
      const { encrypted, iv } = await encrypt(result[field]);
      result[field] = encrypted;
      result[`${field}_iv`] = iv;
    }
  }
  return result;
}
```

**åœ¨ä¸ªäººä¿¡æ¯ç¼–è¾‘é¡µé¢çš„ä½¿ç”¨**ï¼š

```javascript
// pages/my/info-edit/index.js
import { encryptFields } from '~/utils/crypto';

async onSaveInfo() {
  // 1. æ”¶é›†è¡¨å•æ•°æ®
  const formData = {
    name: this.data.name,
    studentNo: this.data.studentNo,
    phone: this.data.phone,
    college: this.data.college,
    major: this.data.major,
  };
  
  // 2. å¯¹æ•æ„Ÿå­—æ®µè¿›è¡Œ AES åŠ å¯†
  const encryptedData = await encryptFields(formData, 
    ['name', 'studentNo', 'phone', 'college', 'major']
  );
  
  // 3. è°ƒç”¨äº‘å‡½æ•°æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  const res = await wx.cloud.callFunction({
    name: 'updateUserInfo',
    data: encryptedData,
  });
  
  if (res.result.code === 200) {
    wx.showToast({ title: 'ä¿å­˜æˆåŠŸ', icon: 'success' });
  }
}
```

#### 4.3.2.2 äº‹ä»¶æ€»çº¿é€šä¿¡

ç³»ç»Ÿä½¿ç”¨äº‹ä»¶æ€»çº¿ï¼ˆeventBusï¼‰å®ç°è·¨é¡µé¢é€šä¿¡ï¼Œå¦‚ä½œä¸šæäº¤åé€šçŸ¥åˆ—è¡¨é¡µåˆ·æ–°ï¼š

```javascript
// utils/eventBus.js
class EventBus {
  constructor() {
    this.events = {};
  }
  
  on(eventName, callback) {
    if (!this.events[eventName]) {
      this.events[eventName] = [];
    }
    this.events[eventName].push(callback);
  }
  
  emit(eventName, data) {
    if (this.events[eventName]) {
      this.events[eventName].forEach(callback => callback(data));
    }
  }
  
  off(eventName, callback) {
    if (this.events[eventName]) {
      this.events[eventName] = this.events[eventName].filter(cb => cb !== callback);
    }
  }
}

export default new EventBus();
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```javascript
// ä½œä¸šæäº¤é¡µé¢ - è§¦å‘äº‹ä»¶
import eventBus from '~/utils/eventBus';
eventBus.emit('assignment-submitted', { assignmentId: this.data.assignmentId });

// ä½œä¸šåˆ—è¡¨é¡µé¢ - ç›‘å¬äº‹ä»¶
onLoad() {
  eventBus.on('assignment-submitted', this.refreshList.bindthis));
}
onUnload() {
  eventBus.off('assignment-submitted', this.refreshList);
}
```

---

## 4.4 åç«¯äº‘å‡½æ•°è®¾è®¡ä¸å®ç°

### 4.4.1 äº‘å‡½æ•°æ¶æ„è®¾è®¡

ç³»ç»Ÿå…±å®ç° 35 ä¸ªäº‘å‡½æ•°ï¼ŒæŒ‰åŠŸèƒ½åˆ†ç±»å¦‚ä¸‹ï¼š

| åˆ†ç±» | äº‘å‡½æ•°åç§° | åŠŸèƒ½è¯´æ˜ |
|-----|-----------|---------|
| **ç”¨æˆ·è®¤è¯** | login | ç”¨æˆ·ç™»å½•ï¼ˆOpenID è‡ªåŠ¨æ³¨å†Œï¼‰ |
| | register | ç”¨æˆ·æ³¨å†Œï¼ˆé¢„ç•™ï¼‰ |
| | getUserInfo | è·å–ç”¨æˆ·ä¿¡æ¯ |
| | updateUserInfo | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ |
| **ç­çº§ç®¡ç†** | createClass | åˆ›å»ºç­çº§ |
| | getClassList | è·å–ç­çº§åˆ—è¡¨ |
| | getClassDetail | è·å–ç­çº§è¯¦æƒ… |
| | updateClass | æ›´æ–°ç­çº§ä¿¡æ¯ |
| | joinClass | åŠ å…¥ç­çº§ |
| | exitClass | é€€å‡ºç­çº§ |
| **æˆå‘˜ç®¡ç†** | getClassMembers | è·å–ç­çº§æˆå‘˜ |
| | addClassMember | æ·»åŠ æˆå‘˜ |
| | removeClassMember | ç§»é™¤æˆå‘˜ |
| | setClassAdmin | è®¾ç½®ç®¡ç†å‘˜ |
| | unsetClassAdmin | å–æ¶ˆç®¡ç†å‘˜ |
| | checkAdminStatus | æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€ |
| **é€šçŸ¥ç®¡ç†** | createNotice | å‘å¸ƒé€šçŸ¥ |
| | getNotices | è·å–é€šçŸ¥åˆ—è¡¨ |
| | getNoticeDetail | è·å–é€šçŸ¥è¯¦æƒ… |
| | deleteNotice | åˆ é™¤é€šçŸ¥ |
| **ä½œä¸šç®¡ç†** | createAssignment | å‘å¸ƒä½œä¸š |
| | getAssignments | è·å–ä½œä¸šåˆ—è¡¨ |
| | getAssignmentDetail | è·å–ä½œä¸šè¯¦æƒ… |
| | submitAssignment | æäº¤ä½œä¸š |
| | deleteAssignment | åˆ é™¤ä½œä¸š |
| **è¯·å‡ç®¡ç†** | createLeaveRequest | æäº¤è¯·å‡ |
| | getLeaveRequests | è·å–è¯·å‡åˆ—è¡¨ |
| | getLeaveRequestDetail | è·å–è¯·å‡è¯¦æƒ… |
| | approveLeaveRequest | å®¡æ‰¹è¯·å‡ |
| **ç­¾åˆ°ç®¡ç†** | generateCheckInCode | ç”Ÿæˆç­¾åˆ°ç  |
| | getCheckInCode | è·å–å½“å‰ç­¾åˆ°ç  |
| | checkInByCode | ç­¾åˆ°ç ç­¾åˆ° |
| | checkInByLocation | å®šä½ç­¾åˆ°ï¼ˆé¢„ç•™ï¼‰ |
| | getCheckInRecords | è·å–ç­¾åˆ°è®°å½• |
| | deleteCheckInCode | åˆ é™¤ç­¾åˆ°ç  |
| | updateCheckInStatus | æ›´æ–°ç­¾åˆ°çŠ¶æ€ |
| **æ¶ˆæ¯ä¸­å¿ƒ** | getMessages | è·å–æ¶ˆæ¯æ±‡æ€» |
| **æ–‡ä»¶å¤„ç†** | getFileTempUrl | è·å–æ–‡ä»¶ä¸´æ—¶é“¾æ¥ |
| **æµ‹è¯•å·¥å…·** | seedTestUsers | ç”Ÿæˆæµ‹è¯•æ•°æ® |

### 4.4.2 å…³é”®äº‘å‡½æ•°å®ç°

#### 4.4.2.1 ç”¨æˆ·ç™»å½•äº‘å‡½æ•°ï¼ˆloginï¼‰

```javascript
// cloudfunctions/login/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();
const users = db.collection('users');

exports.main = async (event) => {
  try {
    // 1. è·å–å¾®ä¿¡ä¸Šä¸‹æ–‡ä¸­çš„ OpenID
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;

    if (!openid) {
      return { code: 401, message: 'è·å–å¾®ä¿¡ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•' };
    }

    // 2. æ ¹æ® openid æŸ¥æ‰¾ç”¨æˆ·
    const userRes = await users.where({ openid }).get();
    
    let user;
    let userId;

    if (userRes.data.length === 0) {
      // 3. ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·
      const newUser = {
        openid,
        name: '',
        avatar: '',
        role: 0,
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };
      
      const addRes = await users.add({ data: newUser });
      userId = addRes._id;
      user = { _id: userId, ...newUser };
    } else {
      // 4. ç”¨æˆ·å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›
      [user] = userRes.data;
      userId = user._id;
    }

    // 5. è¿”å›ç™»å½•ç»“æœ
    return {
      code: 200,
      success: true,
      message: 'ç™»å½•æˆåŠŸ',
      data: {
        userId: userId,
        role: user.role || 0,
      },
    };
  } catch (e) {
    console.error('login error:', e);
    return { code: 500, message: 'ç™»å½•å¤±è´¥', error: e.message };
  }
};
```

#### 4.4.2.2 æ›´æ–°ç”¨æˆ·ä¿¡æ¯äº‘å‡½æ•°ï¼ˆupdateUserInfoï¼‰

è¯¥äº‘å‡½æ•°æ¼”ç¤ºäº†å®Œæ•´çš„åŠ å¯†æ•°æ®å¤„ç†æµç¨‹ï¼šå‰ç«¯åŠ å¯† â†’ äº‘å‡½æ•°è§£å¯† â†’ ä¸šåŠ¡å¤„ç† â†’ é‡æ–°åŠ å¯† â†’ å­˜å‚¨ã€‚

```javascript
// cloudfunctions/updateUserInfo/index.js
const cloud = require('wx-server-sdk');
const { decryptFields, encryptFieldsForDB } = require('./common/aes');

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();
const users = db.collection('users');

exports.main = async (event) => {
  try {
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;

    // 1. è§£å¯†å‰ç«¯ä¼ æ¥çš„åŠ å¯†å­—æ®µ
    const input = decryptFields(event, ['name', 'studentNo', 'college', 'major', 'phone']);
    
    // 2. æŸ¥æ‰¾ç”¨æˆ·
    const userRes = await users.where({ openid }).get();
    if (userRes.data.length === 0) {
      return { code: 404, message: 'ç”¨æˆ·ä¸å­˜åœ¨' };
    }
    const userId = userRes.data[0]._id;

    // 3. æ„å»ºæ›´æ–°æ•°æ®
    let updateData = { updatedAt: Date.now() };
    const sensitiveFields = [];
    
    // å¤„ç†å„å­—æ®µï¼ˆavatar ä¸åŠ å¯†ï¼‰
    if (input.avatar !== undefined) {
      updateData.avatar = String(input.avatar).trim();
    }
    if (input.name !== undefined) {
      updateData.name = String(input.name).trim();
      sensitiveFields.push('name');
    }
    if (input.phone !== undefined) {
      updateData.phone = String(input.phone).trim();
      sensitiveFields.push('phone');
      // ç”Ÿæˆæ‰‹æœºå·å“ˆå¸Œç”¨äºæŸ¥è¯¢
      const crypto = require('crypto');
      updateData.phone_hash = crypto.createHash('sha256').update(updateData.phone).digest('hex');
    }
    // ... å…¶ä»–å­—æ®µç±»ä¼¼å¤„ç†
    
    // 4. å†™åº“å‰é‡æ–°åŠ å¯†æ•æ„Ÿå­—æ®µ
    if (sensitiveFields.length > 0) {
      updateData = encryptFieldsForDB(updateData, sensitiveFields);
    }

    // 5. æ›´æ–°æ•°æ®åº“
    await users.doc(userId).update({ data: updateData });

    return { code: 200, success: true, message: 'æ›´æ–°æˆåŠŸ' };
  } catch (e) {
    console.error('updateUserInfo error:', e);
    return { code: 500, message: 'æ›´æ–°å¤±è´¥', error: e.message };
  }
};
```

#### 4.4.2.3 è¯·å‡å®¡æ‰¹äº‘å‡½æ•°ï¼ˆapproveLeaveRequestï¼‰

è¯¥äº‘å‡½æ•°æ¼”ç¤ºäº†ç®¡ç†å‘˜æƒé™æ ¡éªŒçš„å®ç°æ–¹å¼ï¼š

```javascript
// cloudfunctions/approveLeaveRequest/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();
const leaveRequests = db.collection('leave_requests');
const courses = db.collection('courses');
const courseMembers = db.collection('course_members');

exports.main = async (event) => {
  try {
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;
    const { leaveRequestId, status, comment } = event;

    // 1. å‚æ•°æ ¡éªŒ
    if (!leaveRequestId) {
      return { code: 400, message: 'è¯·å‡IDä¸èƒ½ä¸ºç©º' };
    }

    // 2. è·å–è¯·å‡ä¿¡æ¯
    const leaveRes = await leaveRequests.doc(leaveRequestId).get();
    if (!leaveRes.data) {
      return { code: 404, message: 'è¯·å‡ä¸å­˜åœ¨' };
    }
    const courseId = leaveRes.data.courseId;

    // 3. æƒé™æ ¡éªŒï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
    let isAdmin = false;
    
    // æ–¹å¼1ï¼šæ£€æŸ¥ course_members è¡¨ä¸­çš„ role
    const memberRes = await courseMembers.where({
      courseId: courseId,
      openid: openid,
    }).get();
    isAdmin = memberRes.data.length > 0 && memberRes.data[0].role === 'admin';

    // æ–¹å¼2ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç­çº§åˆ›å»ºè€…
    if (!isAdmin) {
      const courseRes = await courses.doc(courseId).get();
      if (courseRes.data && courseRes.data.creatorOpenid === openid) {
        isAdmin = true;
      }
    }

    if (!isAdmin) {
      return { code: 403, message: 'æ— æƒé™å®¡æ‰¹è¯·å‡' };
    }

    // 4. æ›´æ–°è¯·å‡çŠ¶æ€
    await leaveRequests.doc(leaveRequestId).update({
      data: {
        status: status,  // 1: é€šè¿‡, 2: æ‹’ç»
        comment: comment ? comment.trim() : '',
        approvedAt: Date.now(),
        updatedAt: Date.now(),
      },
    });

    return { code: 200, success: true, message: 'å®¡æ‰¹æˆåŠŸ' };
  } catch (e) {
    console.error('approveLeaveRequest error:', e);
    return { code: 500, message: 'å®¡æ‰¹å¤±è´¥', error: e.message };
  }
};
```

#### 4.4.2.4 ç”Ÿæˆç­¾åˆ°ç äº‘å‡½æ•°ï¼ˆgenerateCheckInCodeï¼‰

```javascript
// cloudfunctions/generateCheckInCode/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();
const checkInCodes = db.collection('checkin_codes');
const courseMembers = db.collection('course_members');
const courses = db.collection('courses');

exports.main = async (event) => {
  try {
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;
    const { courseId, code, expireTime, note } = event;

    // 1. å‚æ•°æ ¡éªŒ
    if (!courseId || !code) {
      return { code: 400, message: 'å‚æ•°ä¸å®Œæ•´' };
    }

    // 2. æƒé™æ ¡éªŒï¼ˆåŒä¸Šï¼‰
    // ... çœç•¥æƒé™æ ¡éªŒä»£ç 

    // 3. å°†ä¹‹å‰çš„ç­¾åˆ°ç æ ‡è®°ä¸ºè¿‡æœŸ
    const now = Date.now();
    await checkInCodes.where({
      courseId: courseId,
      expireTime: db.command.gt(now),
    }).update({
      data: { expireTime: now - 1 },
    });

    // 4. åˆ›å»ºæ–°ç­¾åˆ°ç 
    await checkInCodes.add({
      data: {
        courseId: courseId,
        code: code,
        expireTime: expireTime,  // é»˜è®¤ 5 åˆ†é’Ÿæœ‰æ•ˆæœŸ
        note: note || '',
        createdAt: Date.now(),
      },
    });

    return { code: 200, success: true, message: 'ç”ŸæˆæˆåŠŸ' };
  } catch (e) {
    console.error('generateCheckInCode error:', e);
    return { code: 500, message: 'ç”Ÿæˆç­¾åˆ°ç å¤±è´¥', error: e.message };
  }
};
```

### 4.4.3 æƒé™æ ¡éªŒæœºåˆ¶å®ç°

ç³»ç»Ÿé‡‡ç”¨ç»Ÿä¸€çš„æƒé™æ ¡éªŒæ¨¡å¼ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š

```mermaid
flowchart TD
    A[äº‘å‡½æ•°æ¥æ”¶è¯·æ±‚] --> B[è·å– OPENID]
    B --> C{éœ€è¦ç®¡ç†å‘˜æƒé™?}
    C -->|å¦| D[æ‰§è¡Œä¸šåŠ¡é€»è¾‘]
    C -->|æ˜¯| E[æŸ¥è¯¢ course_members]
    E --> F{role === 'admin'?}
    F -->|æ˜¯| D
    F -->|å¦| G[æŸ¥è¯¢ courses è¡¨]
    G --> H{creatorOpenid === openid?}
    H -->|æ˜¯| D
    H -->|å¦| I[è¿”å› 403 æ— æƒé™]
    D --> J[è¿”å›ç»“æœ]
```

**æƒé™æ ¡éªŒä»£ç æ¨¡æ¿**ï¼š

```javascript
// é€šç”¨æƒé™æ ¡éªŒå‡½æ•°
async function checkAdminPermission(openid, courseId) {
  // 1. æ£€æŸ¥æˆå‘˜è¡¨ä¸­çš„è§’è‰²
  const memberRes = await courseMembers.where({
    courseId: courseId,
    openid: openid,
  }).get();
  
  if (memberRes.data.length > 0 && memberRes.data[0].role === 'admin') {
    return true;
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦ä¸ºç­çº§åˆ›å»ºè€…
  try {
    const courseRes = await courses.doc(courseId).get();
    if (courseRes.data && courseRes.data.creatorOpenid === openid) {
      return true;
    }
  } catch (e) {
    console.error('æŸ¥è¯¢ç­çº§å¤±è´¥:', e);
  }
  
  return false;
}
```

---

## 4.5 AES åŠ å¯†æ¨¡å—å®ç°

### 4.5.1 åŠ å¯†æ–¹æ¡ˆè®¾è®¡

#### 4.5.1.1 åŠ å¯†å‚æ•°é…ç½®

| å‚æ•° | å€¼ | è¯´æ˜ |
|-----|-----|------|
| ç®—æ³• | AES-256-CBC | é«˜å¼ºåº¦å¯¹ç§°åŠ å¯†ç®—æ³• |
| å¯†é’¥é•¿åº¦ | 256 ä½ï¼ˆ32 å­—èŠ‚ï¼‰ | å¯†é’¥ä¸è¶³æ—¶å³ä¾§è¡¥ 0 |
| IV é•¿åº¦ | 128 ä½ï¼ˆ16 å­—èŠ‚ï¼‰ | æ¯æ¬¡åŠ å¯†éšæœºç”Ÿæˆ |
| å¡«å……æ–¹å¼ | PKCS#7 | æ ‡å‡†å¡«å……æ¨¡å¼ |
| ç¼–ç æ–¹å¼ | Base64 | å¯†æ–‡å’Œ IV çš„å­˜å‚¨æ ¼å¼ |

#### 4.5.1.2 å‰åç«¯åŠ å¯†è§£å¯†æµç¨‹

```mermaid
sequenceDiagram
    participant ç”¨æˆ· as ç”¨æˆ·
    participant å‰ç«¯ as å°ç¨‹åºå‰ç«¯
    participant äº‘å‡½æ•° as äº‘å‡½æ•°
    participant æ•°æ®åº“ as äº‘æ•°æ®åº“

    ç”¨æˆ·->>å‰ç«¯: è¾“å…¥æ•æ„Ÿä¿¡æ¯ï¼ˆå§“åã€å­¦å·ã€æ‰‹æœºå·ï¼‰
    
    rect rgb(200, 230, 200)
        Note over å‰ç«¯: å‰ç«¯åŠ å¯†æµç¨‹
        å‰ç«¯->>å‰ç«¯: 1. è·å–åŠ å¯†å¯†é’¥
        å‰ç«¯->>å‰ç«¯: 2. ç”Ÿæˆéšæœº IVï¼ˆ16å­—èŠ‚ï¼‰
        å‰ç«¯->>å‰ç«¯: 3. AES-256-CBC åŠ å¯†
        å‰ç«¯->>å‰ç«¯: 4. å¯†æ–‡ Base64 ç¼–ç 
    end
    
    å‰ç«¯->>äº‘å‡½æ•°: å‘é€åŠ å¯†æ•°æ® {field: å¯†æ–‡, field_iv: IV}
    
    rect rgb(230, 200, 200)
        Note over äº‘å‡½æ•°: äº‘å‡½æ•°è§£å¯†æµç¨‹
        äº‘å‡½æ•°->>äº‘å‡½æ•°: 1. è·å–åŠ å¯†å¯†é’¥
        äº‘å‡½æ•°->>äº‘å‡½æ•°: 2. è§£æ IVï¼ˆå…¼å®¹æ˜æ–‡/Base64ï¼‰
        äº‘å‡½æ•°->>äº‘å‡½æ•°: 3. AES-256-CBC è§£å¯†
        äº‘å‡½æ•°->>äº‘å‡½æ•°: 4. è·å–æ˜æ–‡
    end
    
    äº‘å‡½æ•°->>äº‘å‡½æ•°: ä¸šåŠ¡é€»è¾‘å¤„ç†
    
    rect rgb(200, 200, 230)
        Note over äº‘å‡½æ•°: äº‘å‡½æ•°åŠ å¯†å­˜å‚¨æµç¨‹
        äº‘å‡½æ•°->>äº‘å‡½æ•°: 1. ç”Ÿæˆæ–° IVï¼ˆéšæœºå­—èŠ‚ï¼‰
        äº‘å‡½æ•°->>äº‘å‡½æ•°: 2. AES-256-CBC åŠ å¯†
        äº‘å‡½æ•°->>äº‘å‡½æ•°: 3. å¯†æ–‡å’ŒIV Base64 ç¼–ç 
    end
    
    äº‘å‡½æ•°->>æ•°æ®åº“: å­˜å‚¨åŠ å¯†æ•°æ® {field: å¯†æ–‡, field_iv: IV}
    æ•°æ®åº“-->>äº‘å‡½æ•°: å­˜å‚¨æˆåŠŸ
    äº‘å‡½æ•°-->>å‰ç«¯: è¿”å›æ“ä½œç»“æœ
    å‰ç«¯-->>ç”¨æˆ·: æ˜¾ç¤ºæ“ä½œç»“æœ
```

### 4.5.2 åŠ å¯†æ¨¡å—é›†æˆ

#### 4.5.2.1 å‰ç«¯åŠ å¯†æ¨¡å—ï¼ˆutils/crypto.jsï¼‰

```javascript
// æ ¸å¿ƒåŠ å¯†å‡½æ•°
const CryptoJS = require('crypto-js');

// ç”Ÿæˆéšæœº IV
function generateIV() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let iv = '';
  for (let i = 0; i < 16; i++) {
    iv += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return iv;
}

// AES-256-CBC åŠ å¯†
function encryptAES(plaintext, key, iv) {
  if (!plaintext) return '';
  
  const fullKey = key.padEnd(32, '0').slice(0, 32);
  const encrypted = CryptoJS.AES.encrypt(plaintext, CryptoJS.enc.Utf8.parse(fullKey), {
    iv: CryptoJS.enc.Utf8.parse(iv),
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7,
  });
  return encrypted.toString();  // Base64 ç¼–ç çš„å¯†æ–‡
}

// æ‰¹é‡åŠ å¯†æŒ‡å®šå­—æ®µ
async function encryptFields(data, fields) {
  const result = { ...data };
  const key = await getEncryptionKey();
  
  for (const field of fields) {
    if (result[field] !== undefined && result[field] !== null) {
      const iv = generateIV();
      result[field] = encryptAES(String(result[field]), key, iv);
      result[`${field}_iv`] = iv;
    }
  }
  return result;
}
```

#### 4.5.2.2 åç«¯åŠ å¯†æ¨¡å—ï¼ˆcommon/aes.jsï¼‰

```javascript
// äº‘å‡½æ•°ç«¯åŠ å¯†æ¨¡å—
const crypto = require('crypto');

const ENCRYPTION_KEY = (process.env.ENCRYPTION_KEY || 'a9F$3dL!8kPz2xQw')
  .padEnd(32, '0').slice(0, 32);
const ALGORITHM = 'aes-256-cbc';
const IV_LENGTH = 16;

// è§£å¯†å‡½æ•°ï¼ˆå…¼å®¹å‰ç«¯æ˜æ–‡IVå’ŒæœåŠ¡ç«¯Base64 IVï¼‰
function decrypt(ciphertext, ivEncoded) {
  if (!ciphertext || !ivEncoded) return '';
  
  // å…¼å®¹ä¸¤ç§ IV æ ¼å¼
  let iv;
  if (ivEncoded.length === IV_LENGTH) {
    iv = Buffer.from(ivEncoded, 'utf8');  // å‰ç«¯ä¼ æ¥çš„æ˜æ–‡ IV
  } else {
    iv = Buffer.from(ivEncoded, 'base64');  // æœåŠ¡ç«¯å­˜å‚¨çš„ Base64 IV
  }
  
  const decipher = crypto.createDecipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, 'utf8'), iv);
  let decrypted = decipher.update(ciphertext, 'base64', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}

// åŠ å¯†å‡½æ•°ï¼ˆç”¨äºå­˜å‚¨ï¼‰
function encrypt(plaintext) {
  const iv = crypto.randomBytes(IV_LENGTH);
  const cipher = crypto.createCipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, 'utf8'), iv);
  let encrypted = cipher.update(String(plaintext), 'utf8', 'base64');
  encrypted += cipher.final('base64');
  return { ciphertext: encrypted, iv: iv.toString('base64') };
}

// æ‰¹é‡è§£å¯†å­—æ®µ
function decryptFields(payload, fields) {
  const data = { ...payload };
  fields.forEach((field) => {
    if (data[field] && data[`${field}_iv`]) {
      data[field] = decrypt(data[field], data[`${field}_iv`]);
    }
  });
  return data;
}

// æ‰¹é‡åŠ å¯†å­—æ®µï¼ˆç”¨äºå­˜å‚¨ï¼‰
function encryptFieldsForDB(payload, fields) {
  const data = { ...payload };
  fields.forEach((field) => {
    if (data[field] != null) {
      const { ciphertext, iv } = encrypt(data[field]);
      data[field] = ciphertext;
      data[`${field}_iv`] = iv;
    }
  });
  return data;
}
```

### 4.5.3 å¯†é’¥ç®¡ç†ä¸å®‰å…¨æ€§è€ƒè™‘

#### 4.5.3.1 å¯†é’¥å­˜å‚¨ç­–ç•¥

| ç¯å¢ƒ | å¯†é’¥æ¥æº | å®‰å…¨çº§åˆ« |
|-----|---------|---------|
| å¼€å‘ç¯å¢ƒ | é…ç½®æ–‡ä»¶ï¼ˆconfig.jsï¼‰ | ä½ |
| æµ‹è¯•ç¯å¢ƒ | ç¯å¢ƒå˜é‡ | ä¸­ |
| ç”Ÿäº§ç¯å¢ƒ | äº‘å‡½æ•°ç¯å¢ƒå˜é‡ / å¯†é’¥ç®¡ç†æœåŠ¡ | é«˜ |

#### 4.5.3.2 å®‰å…¨æ€§å»ºè®®

1. **å¯†é’¥è½®æ¢**ï¼šå»ºè®®å®šæœŸæ›´æ¢åŠ å¯†å¯†é’¥ï¼Œé…åˆæ•°æ®è¿ç§»å·¥å…·æ‰¹é‡é‡æ–°åŠ å¯†å†å²æ•°æ®ã€‚

2. **å¯†é’¥éš”ç¦»**ï¼šå‰ç«¯å¯†é’¥ä»…ç”¨äºä¼ è¾“åŠ å¯†ï¼Œäº‘å‡½æ•°ä½¿ç”¨ç‹¬ç«‹å¯†é’¥è¿›è¡Œå­˜å‚¨åŠ å¯†ï¼Œå¯è¿›ä¸€æ­¥æå‡å®‰å…¨æ€§ã€‚

3. **IV å”¯ä¸€æ€§**ï¼šæ¯æ¬¡åŠ å¯†å¿…é¡»ä½¿ç”¨éšæœº IVï¼Œç¦æ­¢é‡å¤ä½¿ç”¨ IVã€‚

4. **æ—¥å¿—è„±æ•**ï¼šäº‘å‡½æ•°æ—¥å¿—ä¸­ç¦æ­¢æ‰“å°æ˜æ–‡æ•æ„Ÿæ•°æ®ï¼Œè°ƒè¯•æ—¶ä½¿ç”¨ `[å·²è®¾ç½®]` å ä½ç¬¦ã€‚

---

## 4.6 ç³»ç»Ÿéƒ¨ç½²ä¸é…ç½®

### 4.6.1 å¾®ä¿¡å°ç¨‹åºé¡¹ç›®é…ç½®

**project.config.json å…³é”®é…ç½®**ï¼š

```json
{
  "appid": "wx87b7d20ff5c92995",
  "projectname": "class-information-system",
  "compileType": "miniprogram",
  "libVersion": "3.13.2",
  "cloudfunctionRoot": "cloudfunctions/",
  "setting": {
    "es6": true,
    "postcss": true,
    "minified": true,
    "enhance": true,
    "useCompilerPlugins": ["less"]
  }
}
```

**app.json é¡µé¢é…ç½®**ï¼š

```json
{
  "pages": [
    "pages/home/index",
    "pages/message/index",
    "pages/my/index"
  ],
  "subpackages": [
    {
      "root": "pages/class",
      "pages": [
        "create/index",
        "detail/index",
        "members/index",
        "notices/index",
        "assignments/index",
        "leave/index",
        "attendance/index"
      ]
    }
  ],
  "tabBar": {
    "custom": true,
    "list": [
      { "pagePath": "pages/home/index", "text": "æ¶ˆæ¯" },
      { "pagePath": "pages/message/index", "text": "ç­çº§" },
      { "pagePath": "pages/my/index", "text": "æˆ‘çš„" }
    ]
  },
  "permission": {
    "scope.userLocation": {
      "desc": "ä½ çš„ä½ç½®ä¿¡æ¯å°†ç”¨äºå®šä½ç­¾åˆ°åŠŸèƒ½"
    }
  }
}
```

### 4.6.2 äº‘å¼€å‘ç¯å¢ƒé…ç½®

**äº‘å¼€å‘ç¯å¢ƒåˆå§‹åŒ–**ï¼š

1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å¼€é€šäº‘å¼€å‘æœåŠ¡
2. åˆ›å»ºäº‘å¼€å‘ç¯å¢ƒï¼ˆå¦‚ï¼š`class-info-prod`ï¼‰
3. åœ¨ `app.js` ä¸­åˆå§‹åŒ–äº‘å¼€å‘ï¼š

```javascript
// app.js
App({
  onLaunch() {
    if (!wx.cloud) {
      console.error('è¯·ä½¿ç”¨ 2.2.3 æˆ–ä»¥ä¸Šçš„åŸºç¡€åº“ä»¥ä½¿ç”¨äº‘èƒ½åŠ›');
    } else {
      wx.cloud.init({
        env: 'class-info-prod',  // äº‘å¼€å‘ç¯å¢ƒ ID
        traceUser: true,
      });
    }
  },
});
```

**äº‘å‡½æ•°éƒ¨ç½²**ï¼š

```bash
# åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å³é”®ç‚¹å‡» cloudfunctions ç›®å½•
# é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
```

### 4.6.3 æ•°æ®åº“åˆå§‹åŒ–

**åˆ›å»ºæ•°æ®é›†åˆ**ï¼š

åœ¨äº‘å¼€å‘æ§åˆ¶å°ä¸­åˆ›å»ºä»¥ä¸‹é›†åˆï¼š

| é›†åˆåç§° | æ•°æ®æƒé™ | è¯´æ˜ |
|---------|---------|------|
| users | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | ç”¨æˆ·è¡¨ |
| courses | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | ç­çº§è¡¨ |
| course_members | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | ç­çº§æˆå‘˜è¡¨ |
| notices | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | é€šçŸ¥è¡¨ |
| assignments | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | ä½œä¸šè¡¨ |
| assignment_submissions | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | ä½œä¸šæäº¤è¡¨ |
| leave_requests | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | è¯·å‡è¡¨ |
| checkin_codes | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | ç­¾åˆ°ç è¡¨ |
| checkin_records | ä»…åˆ›å»ºè€…å¯å†™ï¼Œæ‰€æœ‰äººå¯è¯» | ç­¾åˆ°è®°å½•è¡¨ |

**åˆ›å»ºç´¢å¼•**ï¼ˆåœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ é›†åˆ â†’ ç´¢å¼•ç®¡ç†ï¼‰ï¼š

```javascript
// users é›†åˆç´¢å¼•
db.collection('users').createIndex({ openid: 1 }, { unique: true });

// course_members é›†åˆå¤åˆç´¢å¼•
db.collection('course_members').createIndex({ courseId: 1, openid: 1 }, { unique: true });

// checkin_records é›†åˆå¤åˆç´¢å¼•
db.collection('checkin_records').createIndex({ checkInCodeId: 1, userId: 1 }, { unique: true });
```

---

## 4.7 æœ¬ç« å°ç»“

æœ¬ç« è¯¦ç»†é˜è¿°äº†ç­çº§ä¿¡æ¯ç®¡ç†ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°è¿‡ç¨‹ã€‚åœ¨ç³»ç»Ÿæ€»ä½“è®¾è®¡éƒ¨åˆ†ï¼Œé‡‡ç”¨å¾®ä¿¡å°ç¨‹åº + äº‘å¼€å‘çš„ Serverless æ¶æ„ï¼Œå®ç°äº†å‰åç«¯åˆ†ç¦»çš„è½»é‡çº§éƒ¨ç½²æ–¹æ¡ˆã€‚åœ¨æ•°æ®åº“è®¾è®¡éƒ¨åˆ†ï¼ŒåŸºäº MongoDB è®¾è®¡äº† 8 ä¸ªæ ¸å¿ƒæ•°æ®é›†åˆï¼Œå¹¶é’ˆå¯¹æ•æ„Ÿå­—æ®µå®æ–½ AES-256-CBC åŠ å¯†å­˜å‚¨ç­–ç•¥ã€‚åœ¨å‰ç«¯å®ç°éƒ¨åˆ†ï¼Œé›†æˆ TDesign ç»„ä»¶åº“æå‡ç”¨æˆ·ä½“éªŒï¼Œå¹¶å°è£…äº†åŠ å¯†æ¨¡å—å’Œäº‹ä»¶æ€»çº¿ç­‰å·¥å…·ã€‚åœ¨åç«¯å®ç°éƒ¨åˆ†ï¼Œå¼€å‘äº† 35 ä¸ªäº‘å‡½æ•°è¦†ç›–å…¨éƒ¨ä¸šåŠ¡åœºæ™¯ï¼Œå¹¶å»ºç«‹äº†ç»Ÿä¸€çš„æƒé™æ ¡éªŒæœºåˆ¶ã€‚æœ€åï¼Œåœ¨åŠ å¯†æ¨¡å—éƒ¨åˆ†ï¼Œè¯¦ç»†è¯´æ˜äº†å‰åç«¯åŠ è§£å¯†æµç¨‹å’Œå¯†é’¥ç®¡ç†æ–¹æ¡ˆã€‚æœ¬ç« å†…å®¹ä¸ºç³»ç»Ÿçš„æµ‹è¯•å’Œè¿ç»´æä¾›äº†å®Œæ•´çš„æŠ€æœ¯å‚è€ƒã€‚
